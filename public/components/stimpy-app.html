<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<link rel="import" href="../bower_components/app-router/src/app-router.html">

<link rel="import" href="stimpy-ajax.html">


<polymer-element name="stimpy-app" attributes="user selected">

  <template>

    <style>
    
    :host{
      transform: translateZ(0);
    }

    </style>
  
  <stimpy-ajax id="ajax"
      auto
      url="/api/user"
      method="POST"
      handleAs="json"
      on-core-response="{{handleUserResponse}}">
  </stimpy-ajax>
  
  <app-router id="router">
    <app-route path="/" import="../pages/stimpy-posts.html" 
      on-activate-route-end="{{onRouteActivate}}"></app-route>

    <app-route path="/login" import="../pages/stimpy-login.html" 
      on-activate-route-end="{{onRouteActivate}}"></app-route>
  </app-router>


  <!--
  <core-animated-pages valueattr="id" selected="{{selected}}" transitions="cross-fade-all" auto fit>
    
    <stimpy-posts id="posts" user="{{user}}" on-user-tapped="{{userTapped}}" fit></stimpy-posts>

    <stimpy-login id="login" user="{{user}}" fit></stimpy-login>

  </core-animated-pages>
  -->
  </template>

  <script>

    Polymer('stimpy-app', {
      
      observe: {

        user: 'userUpdated'
      },

      ready: function(){

        console.log('stimpy-app ready');
      },

      userUpdated: function(){

        console.log('userUpdated');

        this.$.router.go('/');

        /*
          var currentPath = this.$.router.activeRoute.getAttribute('path');

          if(currentPath != '/'){

          this.$.router.go('');
        }*/
      },

      userTapped: function(){

        console.log('user tapped bubble');

        this.$.router.go('/login');
      },

      handleUserResponse: function(e){

        var response = this.$.ajax.response;

          console.log(response);

          this.user = response.user;
      },

      onRouteActivate: function(e){

        var self = this;

        var activeElement = this.$.router.activeRouteContent.firstChild;

        console.log('active element', activeElement);

        activeElement.addEventListener('ready', function(e){

          console.log('active element ready', this);

          this.bind('user', new PathObserver(self.user));
          self.bind('user', new PathObserver(this.user));

        });


        //activeElement.bind('user', new PathObserver(this.user));
      }
    });

  </script>
</polymer-element>
