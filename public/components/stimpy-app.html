<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<link rel="import" href="../bower_components/app-router/src/app-router.html">

<link rel="import" href="stimpy-ajax.html">

<polymer-element name="stimpy-app" attributes="user">

  <template>

    <style>
    
      :host{
        transform: translateZ(0);
      }

    </style>
    
    <stimpy-ajax id="ajax"
        auto
        url="/api/user"
        method="POST"
        handleAs="json"
        on-core-response="{{handleUserResponse}}">
    </stimpy-ajax>

    <app-router id="router">
      <app-route path="/" import="../pages/stimpy-posts.html" on-activate-route-end="{{routeActivated}}"></app-route>
      <app-route path="/login" import="../pages/stimpy-login.html" on-activate-route-end="{{routeActivated}}"></app-route>
    </app-router>
    
  </template>

  <script>

    Polymer('stimpy-app', {
      
      observe: {

        user: 'userUpdated'
      },

      ready: function(){

        console.log('stimpy-app ready');
      },

      userUpdated: function(e){

        console.log('userUpdated', this.user);
        
        var currentPath = this.$.router.activeRoute.getAttribute('path');

          if(currentPath != '/'){

          this.$.router.go('/');
        }
      },

      handleUserResponse: function(e){

        var response = this.$.ajax.response;

        console.log(response);

        this.user = response.user;
      },

      routeActivated: function(e){

        var activeElement = this.$.router.activeRouteContent.firstChild;

        //console.log('active element', activeElement);

        activeElement.user = this.user;

        this.bind('user', new PathObserver(activeElement, 'user'));

        activeElement.bind('user', new PathObserver(this, 'user'));
      }
    });

  </script>
</polymer-element>